name: Deploy to EC2 via SSM

on:
  push:
    branches: ["main"]

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::095728564755:role/portfolio-blog-machine-ec2-ssm-role
          aws-region: us-east-1

      - name: Send deploy command via SSM
        id: send
        shell: bash
        run: |
          set -euo pipefail

          COMMAND_ID=$(
            aws ssm send-command \
              --document-name "AWS-RunShellScript" \
              --targets "Key=InstanceIds,Values=i-02fe2e43d2c0b05b9" \
              --comment "Deploy from GitHub Actions" \
              --parameters 'commands=["sudo bash /home/ubuntu/MyPortfolioNPersonalBlog/deploy.sh"]' \
              --query "Command.CommandId" \
              --output text
          )

          echo "command_id=$COMMAND_ID" >> "$GITHUB_OUTPUT"
          echo "SSM CommandId: $COMMAND_ID"

      - name: Wait for deploy to finish and print logs
        shell: bash
        run: |
          set -euo pipefail
          COMMAND_ID="${{ steps.send.outputs.command_id }}"
          INSTANCE_ID="i-02fe2e43d2c0b05b9"

          echo "Waiting for command to finish..."
          aws ssm wait command-executed --command-id "$COMMAND_ID" --instance-id "$INSTANCE_ID"

          STATUS=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query "Status" \
            --output text)

          echo "Status: $STATUS"

          STDOUT=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query "StandardOutputContent" \
            --output text || true)

          STDERR=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query "StandardErrorContent" \
            --output text || true)

          echo "----- STDOUT -----"
          echo "$STDOUT"
          echo "----- STDERR -----"
          echo "$STDERR"

          if [[ "$STATUS" != "Success" ]]; then
            echo "Deploy failed (SSM status: $STATUS)"
            exit 1
          fi
